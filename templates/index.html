<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RID+PID Processor</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body { 
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            margin: 0; 
            padding: 20px; 
            background-color: #f4f7fa; 
            color: #22223b;
            line-height: 1.6;
        }
        .container { 
            max-width: 1100px;
            margin: 5px auto;
            background-color: #fff; 
            padding: 15px 15px; 
            border-radius: 14px; 
            box-shadow: 0 6px 24px rgba(34, 34, 59, 0.08); 
        }
        h1 {
            color: #22223b;
            text-align: left;
            margin-bottom: 28px;
            margin-top: 5px;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .main-flex-row {
            display: flex;
            flex-direction: row;
            gap: 32px;
        }
        .left-section, .right-section {
            min-width: 320px;
            transition: flex 0.3s, max-width 0.3s;
        }
        .left-section {
            border-right: 1px solid #e0e0e0;
            padding-right: 32px;
            flex: 1 1 0;
        }
        .right-section {
            padding-left: 10px;
            flex: 1 1 0;
            display: block;
        }
        .main-flex-row.adv-hidden .left-section {
            flex: 1 1 100%;
            max-width: 100%;
            border-right: none;
            padding-right: 0;
        }
        .main-flex-row.adv-hidden .right-section {
            display: none;
        }
        .form-flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .form-group {
            flex: 1 1 250px;
            min-width: 220px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        label { 
            margin-bottom: 6px; 
            font-weight: 600;
            color: #22223b;
            font-size: 1rem;
            letter-spacing: 0.1px;
        }
        input[type="file"], 
        input[type="number"] { 
            width: 100%;
            padding: 10px 12px; 
            border: 1px solid #bfc9d1;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 0;
            font-size: 1rem;
            background: #f8fafc;
            color: #22223b;
            transition: border-color 0.2s;
        }
        input[type="file"]:focus, 
        input[type="number"]:focus {
            border-color: #00b6f0;
            outline: none;
        }
        input[type="file"] {
            cursor: pointer;
        }
        input[type="submit"], button[type="button"] { 
            background-color: #2a0b57;
            color: #fff; 
            padding: 13px 22px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1.1rem;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(42,11,87,0.08);
        }
        input[type="submit"]:hover, button[type="button"]:hover { 
            background-color: #cd25f1;
            color: #fff;
        }
        .flash-messages { 
            list-style: none; 
            padding: 0; 
            margin-bottom: 20px;
        }
        .flash-messages li { 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            border-radius: 6px;
            border: 1px solid transparent;
            font-size: 1rem;
        }
        .flash-messages li.error {
            background-color: #ffe5e5;
            border-color: #ffb3b3;
            color: #b00020;
        }
        .flash-messages li.success {
            background-color: #e6f7f9;
            border-color: #b3eaf7;
            color: #008cba;
        }
        #advanced-options {
            margin-top: 8px;
        }
        a {
            color: #cd25f1;
            text-decoration: underline;
            transition: color 0.2s;
        }
        a:hover {
            color: #2a0b57;
        }
        /* Add pointer cursor for checkbox and its label */
        #process_status_26_only,
        label[for="process_status_26_only"],
        #process_status_26_only + span {
            cursor: pointer;
        }
        @media (max-width: 900px) {
            .container { max-width: 98vw; }
            .main-flex-row { flex-direction: column; gap: 0; }
            .left-section, .right-section { min-width: 0; padding: 0; border: none; }
        }
    </style>
    <!-- Add Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="container">        

        {% set show_messages = messages if messages is defined else get_flashed_messages(with_categories=true) %}
        {% if show_messages %}
          <ul class="flash-messages">
          {% for category, message in show_messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
          <div class="main-flex-row adv-hidden" id="main-flex-row">
            <div class="left-section">
              <h1>RID+PID Processor</h1>
              <div class="form-group">
                <label for="rid_file">RID Lookup File (CSV, recieved via 
                  <a href="https://mail.google.com/" target="_blank">email</a>):
                </label>
                <input type="file" name="rid_file" id="rid_file" accept=".csv" required>
              </div>
              <div class="form-group">
                <br><br>
                <label for="metrics_file">PID Metrics File (Excel, exported from 
                  <a href="http://reports.lucidhq.com/Reports/report/Lucid/Marketplace%20Metrics%20by%20PID" target="_blank">SSRS</a>):
                </label>
                <input type="file" name="metrics_file" id="metrics_file" accept=".xlsx" required>
              </div>
              <div class="form-group" id="survey-loi-group" style="display:none;">
                <br><br>
                <label for="survey_loi" id="survey-loi-label">
                    Survey Completion LOI (Get it from 
                    <span id="surveyid-links">
                      {% if top_surveyids and top_surveyids|length == 1 and top_surveyids[0] %}
                        <a
                          href="https://www.samplicio.us/fulcrum/next/surveys/{{ top_surveyids[0] }}/reports"
                          target="_blank"
                          title="Survey with most RIDs"
                        >Marketplace</a>
                      {% elif top_surveyids and top_surveyids|length > 1 %}
                        Marketplace:
                        {% for sid, count in top_surveyids|zip(top_counts) %}
                            {% if sid %}
                                <a
                                  href="https://www.samplicio.us/fulcrum/next/surveys/{{ sid }}/reports"
                                  target="_blank"
                                  title="{% if loop.index == 1 %}Survey with most RIDs{% elif loop.index == 2 %}Survey with 2nd most RIDs{% elif loop.index == 3 %}Survey with 3rd most RIDs{% endif %}">
                                  {{ sid }}
                                </a>{% if not loop.last %},{% endif %}
                            {% endif %}
                        {% endfor %}
                      {% else %}
                        Marketplace
                      {% endif %}
                    </span>
                    ):
                </label>
                <input type="number" name="survey_loi" id="survey_loi" value="" min="3" max="100" step="0.1" required>
                <div id="show-advanced-btn-row" style="display:none; justify-content: left; width: 100%; margin-top: 24px;">
                  <button type="button" id="toggle-advanced-btn" style="width: 80%; max-width: 350px; font-size: 1.1rem;">
                    Show Advanced Options
                  </button>
                </div>
              </div>
            </div>
            <div class="right-section">
              <div id="advanced-options" style="display: none;">
                <div class="form-flex-row">
                  <div class="form-group">
                    <label for="conversion_rate_threshold">
                        Poor Conversion Rate Threshold, <span style="color:#cd25f1;">(%) lower than:</span>
                    </label>
                    <input type="number" name="conversion_rate_threshold" id="conversion_rate_threshold" value="10" min="0" max="100" step="0.1" required>
                  </div>
                  <div class="form-group">
                    <label for="security_terms_threshold">
                        High Security Terms Threshold, <span style="color:#cd25f1;">(%) higher than:</span>
                    </label>
                    <input type="number" name="security_terms_threshold" id="security_terms_threshold" value="30" min="0" max="100" step="0.1" required>
                  </div>
                  <div class="form-group">
                    <label for="speeder_multiplier">
                        Speeder LOI - <span style="color:#cd25f1;">Divider</span> (session_loi &lt; actual_loi / <span style="color:#cd25f1;">this value</span>):
                    </label>
                    <input type="number" name="speeder_multiplier" id="speeder_multiplier" value="3" min="1" max="10" step="0.1" required>
                  </div>
                  <div class="form-group">
                    <label for="high_loi_multiplier">
                        High LOI, Distracted - <span style="color:#cd25f1;">Multiplier</span> (session_loi &gt; actual_loi * <span style="color:#cd25f1;">this value</span>):
                    </label>
                    <input type="number" name="high_loi_multiplier" id="high_loi_multiplier" value="3" min="1" max="10" step="0.1" required>
                  </div>
                  <div class="form-group">
                    <label for="negative_recs_rate_threshold">
                        High RR% Threshold, <span style="color:#cd25f1;">(%) higher than:</span>
                    </label>
                    <input type="number" name="negative_recs_rate_threshold" id="negative_recs_rate_threshold" value="15" min="0" max="100" step="0.1" required>
                  </div>
                  <div class="form-group">
                    <label>
                      <input type="checkbox" name="process_status_26_only" id="process_status_26_only" checked>
                      <span style="color:#cd25f1;">Process only status=26</span> (Reconciled to Term) rows
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div style="display: flex; justify-content: right; margin-top: 10px;">
            <input type="submit" id="process-btn" value="Process Files & Download Report" style="font-size: 1.3rem; padding: 18px 60px; width: 60%; max-width: 500px; font-weight: bold; letter-spacing: 1px;">
          </div>
        </form>
        <script>
          const ridFileInput = document.getElementById('rid_file');
          const metricsFileInput = document.getElementById('metrics_file');
          const surveyLoiGroup = document.getElementById('survey-loi-group');
          const showAdvancedBtnRow = document.getElementById('show-advanced-btn-row');
          const toggleBtn = document.getElementById('toggle-advanced-btn');
          const advOptions = document.getElementById('advanced-options');
          const mainFlexRow = document.getElementById('main-flex-row');
          const processBtn = document.getElementById('process-btn');
          const status26Checkbox = document.getElementById('process_status_26_only');
          const loiInput = document.getElementById('survey_loi');
          let advVisible = false;

          // Message area for JS alerts
          let jsMsgDiv = document.getElementById('js-msg-div');
          if (!jsMsgDiv) {
            jsMsgDiv = document.createElement('div');
            jsMsgDiv.id = 'js-msg-div';
            jsMsgDiv.style.marginBottom = '16px';
            document.querySelector('.container').insertBefore(jsMsgDiv, document.querySelector('form'));
          }

          // Accumulate messages in an array
          let jsMessages = [];

          function showJsMessages() {
            if (jsMessages.length === 0) {
              jsMsgDiv.innerHTML = '';
              return;
            }
            jsMsgDiv.innerHTML = `<div class="flash-messages">${jsMessages.map(m => `<li class="${m.type}">${m.text}</li>`).join('')}</div>`;
          }
          function addJsMessage(msg, type='error') {
            jsMessages.push({text: msg, type: type});
            showJsMessages();
          }
          function clearJsMessages() {
            jsMessages = [];
            showJsMessages();
          }

          // Toggle advanced options visibility
          toggleBtn.addEventListener('click', function() {
            advVisible = !advVisible;
            advOptions.style.display = advVisible ? 'block' : 'none';
            mainFlexRow.classList.toggle('adv-hidden', !advVisible);
            toggleBtn.textContent = advVisible ? 'Hide Advanced Options' : 'Show Advanced Options';
          });

          // Store parsed data for cross-file checks
          let ridData = null;
          let ridStatus26Count = 0;
          let ridPIDs = [];
          let ridSurveyCounts = [];
          let ridSurveyLinksHtml = '';
          let metricsData = null;
          let metricsPIDs = [];

          function updateProcessBtnState() {
            // Always check these conditions in order of priority
            let disabled = false;
            let tooltip = "";

            // 1. Both files must be uploaded and parsed
            if (!ridData || !metricsData) {
              disabled = true;
              tooltip = "Please upload both RID and Metrics files.";
            }

            // 2. LOI must be present and valid
            else if (!loiInput.value || isNaN(loiInput.value)) {
              disabled = true;
              tooltip = "Please enter a valid LOI value.";
            }

            // 3. If checkbox is checked and no status=26 RIDs
            else if (
              status26Checkbox.checked &&
              ridStatus26Count === 0
            ) {
              disabled = true;
              tooltip = "No status=26 rows in RID file. Uncheck the advanced option to proceed.";
            }

            processBtn.disabled = disabled;
            processBtn.title = disabled ? tooltip : "";
            processBtn.style.cursor = disabled ? "not-allowed" : "";
          }

          // Message display and processing logic
          function processBothFiles() {
            clearJsMessages();

            // Only proceed if both files are uploaded and parsed
            if (!ridData || !metricsData) {
              updateProcessBtnState();
              surveyLoiGroup.style.display = 'none';
              showAdvancedBtnRow.style.display = 'none';
              document.getElementById('surveyid-links').innerHTML = 'Marketplace';
              return;
            }

            // 1. Survey LOI group and advanced button
            surveyLoiGroup.style.display = 'block';
            showAdvancedBtnRow.style.display = 'flex';

            // 2. Surveyid links
            document.getElementById('surveyid-links').innerHTML = ridSurveyLinksHtml;

            // 3b. Warn if there are ids with status other than 26
            if (ridStatus26Count < ridPIDs.length) {
              addJsMessage("RIDs with status other than '26' present! Please update checkbox in Advanced Options as necessary.", "error");
            }

            // 4. PID comparison and counts
            let msg = '';
            msg += `RID file unique PIDs: ${ridPIDs.length}. Metrics file unique PIDs: ${metricsPIDs.length}. `;
            if (ridPIDs.length && metricsPIDs.length) {
              const ridSet = new Set(ridPIDs);
              const metricsSet = new Set(metricsPIDs);
              const onlyInRID = ridPIDs.filter(pid => !metricsSet.has(pid));
              const onlyInMetrics = metricsPIDs.filter(pid => !ridSet.has(pid));
              if (onlyInRID.length > 0) {
                msg += `PIDs in RID sheet but not in PID Metrics: ${onlyInRID.slice(0,5).join(', ')}${onlyInRID.length>5?', ...':''}. `;
              }
              if (onlyInMetrics.length > 0) {
                msg += `PIDs in PID Metrics but not in RID sheet: ${onlyInMetrics.slice(0,5).join(', ')}${onlyInMetrics.length>5?', ...':''}. `;
              }
            }
            if (msg) addJsMessage(msg, "error");

            updateProcessBtnState();
          }

          status26Checkbox.addEventListener('change', updateProcessBtnState);
          loiInput.addEventListener('input', updateProcessBtnState);

          function parseRID(file) {
            // Parse CSV and set global variables
            const reader = new FileReader();
            reader.onload = function(e) {
              const text = e.target.result;
              const lines = text.split(/\r?\n/).filter(Boolean);
              ridData = null;
              ridStatus26Count = 0;
              ridPIDs = [];
              ridSurveyCounts = [];
              ridSurveyLinksHtml = '';
              if (lines.length < 2) {
                ridData = null;
                return processBothFiles();
              }
              const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
              const surveyidIdx = headers.indexOf('surveyid');
              const statusIdx = headers.indexOf('client_responsestatusid');
              const pidIdx = headers.indexOf('pid');
              if (surveyidIdx === -1) {
                ridData = null;
                return processBothFiles();
              }
              const counts = {};
              let status26Count = 0;
              let pids = [];
              for (let i = 1; i < lines.length; ++i) {
                const row = lines[i].split(',');
                if (row.length <= surveyidIdx) continue;
                const val = row[surveyidIdx].trim();
                if (val) counts[val] = (counts[val] || 0) + 1;
                if (statusIdx !== -1 && row.length > statusIdx) {
                  if (row[statusIdx].trim() === '26') status26Count++;
                }
                if (pidIdx !== -1 && row.length > pidIdx) {
                  const pid = row[pidIdx].trim();
                  if (pid) pids.push(pid);
                }
              }
              ridStatus26Count = status26Count;
              ridPIDs = Array.from(new Set(pids));
              ridData = lines;

              // Surveyid links
              const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
              if (sorted.length === 0) {
                ridSurveyLinksHtml = 'Marketplace';
              } else if (sorted.length === 1) {
                ridSurveyLinksHtml = `<a href="https://www.samplicio.us/fulcrum/next/surveys/${sorted[0][0]}/reports" target="_blank" title="Survey with most RIDs">Marketplace</a>`;
              } else {
                ridSurveyLinksHtml = 'Marketplace: ';
                ridSurveyLinksHtml += sorted.map((item, idx) => {
                  const sid = item[0];
                  const title = idx === 0 ? 'Survey with most RIDs' : idx === 1 ? 'Survey with 2nd most RIDs' : 'Survey with 3rd most RIDs';
                  return `<a href="https://www.samplicio.us/fulcrum/next/surveys/${sid}/reports" target="_blank" title="${title}">${sid}</a>`;
                }).join(', ');
              }
              processBothFiles();
            };
            reader.readAsText(file);
          }

          function parseMetrics(file) {
            // Parse Excel and set global variables
            const reader = new FileReader();
            reader.onload = function(e) {
              if (typeof XLSX === 'undefined') {
                metricsData = null;
                addJsMessage("Excel comparison requires SheetJS (xlsx) library loaded.", "error");
                processBothFiles();
                return;
              }
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, {type: 'array'});
              let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('marketplace metrics'));
              if (!sheetName) sheetName = workbook.SheetNames[0];
              const sheet = workbook.Sheets[sheetName];
              const json = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
              metricsData = null;
              metricsPIDs = [];
              if (json.length <= 6) {
                metricsData = json;
                processBothFiles();
                return;
              }
              const headers = json[5].map(h => h.toString().trim().toLowerCase());
              const pidIdx = headers.indexOf('pid');
              let pids = [];
              for (let i = 6; i < json.length; ++i) {
                const row = json[i];
                if (pidIdx !== -1 && row.length > pidIdx) {
                  const pid = row[pidIdx].toString().trim();
                  if (pid) pids.push(pid);
                }
              }
              metricsPIDs = Array.from(new Set(pids));
              metricsData = json;
              processBothFiles();
            };
            reader.readAsArrayBuffer(file);
          }

          ridFileInput.addEventListener('change', function(event) {
            // Always re-parse both files and refresh all prompts
            clearJsMessages();
            ridData = null;
            ridStatus26Count = 0;
            ridPIDs = [];
            ridSurveyCounts = [];
            ridSurveyLinksHtml = '';
            if (event.target.files[0]) {
              parseRID(event.target.files[0]);
            } else {
              ridData = null;
              surveyLoiGroup.style.display = 'none';
              showAdvancedBtnRow.style.display = 'none';
              document.getElementById('surveyid-links').innerHTML = 'Marketplace';
              clearJsMessages();
              updateProcessBtnState();
            }
            // If metrics file is already uploaded, re-parse it to ensure all checks are up to date
            if (metricsFileInput.files[0]) {
              parseMetrics(metricsFileInput.files[0]);
            }
          });

          metricsFileInput.addEventListener('change', function(event) {
            // Always re-parse both files and refresh all prompts
            clearJsMessages();
            metricsData = null;
            metricsPIDs = [];
            if (event.target.files[0]) {
              parseMetrics(event.target.files[0]);
            } else {
              metricsData = null;
              surveyLoiGroup.style.display = 'none';
              showAdvancedBtnRow.style.display = 'none';
              document.getElementById('surveyid-links').innerHTML = 'Marketplace';
              clearJsMessages();
              updateProcessBtnState();
            }
            // If RID file is already uploaded, re-parse it to ensure all checks are up to date
            if (ridFileInput.files[0]) {
              parseRID(ridFileInput.files[0]);
            }
          });
        </script>
        <!-- SheetJS for Excel parsing in browser -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    </div>
  </body>
</html>